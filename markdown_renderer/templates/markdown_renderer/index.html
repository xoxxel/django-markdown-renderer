{% load static %}
<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>Markdown â†’ HTML Renderer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src *; media-src *; frame-src *; style-src 'unsafe-inline' 'self'; script-src 'unsafe-inline' 'self';" />
  <link rel="stylesheet" href="{% static 'markdown_renderer/style.css' %}">
</head>
<body>
  <header>
    <h1>Markdown â†’ HTML Renderer</h1>
    <div class="toolbar">
      <div class="row">
        <label><input type="checkbox" id="live" /> Live Preview</label>
        <span class="status" id="status">Ready</span>
      </div>
      <button id="renderBtn">Render</button>
    </div>
  </header>

  <main>
    <section class="pane">
      <h2>Input (.md)</h2>
      <textarea id="md" placeholder="# Hello Markdown ðŸš€
- This is a sample
- **bold**, *italic*, `code`
```js
console.log('Hello Markdown');
```"></textarea>
    </section>

    <section class="pane">
      <h2>Preview (Safe HTML)</h2>
      <div id="preview" class="preview"><em>HTML output will be displayed here...</em></div>
    </section>
  </main>

  <script>
    const ENDPOINT = "{% url 'render_markdown' %}";
    const mdEl = document.getElementById("md");
    const previewEl = document.getElementById("preview");
    const renderBtn = document.getElementById("renderBtn");
    const liveEl = document.getElementById("live");
    const statusEl = document.getElementById("status");

    // Emoji picker logic
    const emojiList = [
      ':smile:', ':rocket:', ':heart:', ':thumbsup:', ':fire:', ':star:', ':100:', ':clap:', ':eyes:', ':wave:', ':tada:', ':thinking:', ':sunglasses:', ':cry:', ':grin:', ':wink:', ':ok_hand:', ':pray:', ':confetti_ball:', ':poop:', ':blush:', ':angry:', ':sleeping:', ':zzz:', ':no_mouth:', ':neutral_face:', ':joy:', ':sob:', ':facepalm:', ':muscle:', ':skull:', ':alien:', ':robot:', ':cat:', ':dog:', ':sun:', ':moon:', ':rainbow:', ':rose:', ':crown:', ':gift:', ':balloon:', ':cake:', ':coffee:', ':pizza:', ':soccer:', ':basketball:', ':car:', ':airplane:', ':phone:', ':computer:', ':moneybag:', ':gem:', ':warning:', ':checkered_flag:', ':medal:', ':trophy:'
    ];
    let emojiBox = null;
    mdEl.addEventListener('input', function(e) {
      const val = mdEl.value;
      const pos = mdEl.selectionStart;
      const before = val.slice(0, pos);
      const match = before.match(/:(\w{2,})$/);
      if (match) {
        const query = match[1];
        const filtered = emojiList.filter(e => e.includes(query));
        if (filtered.length) {
          if (!emojiBox) {
            emojiBox = document.createElement('div');
            emojiBox.style.position = 'absolute';
            emojiBox.style.background = '#23283a';
            emojiBox.style.color = '#e8ecf1';
            emojiBox.style.border = '1px solid #5aa6ff';
            emojiBox.style.borderRadius = '8px';
            emojiBox.style.zIndex = 1000;
            emojiBox.style.fontSize = '15px';
            emojiBox.style.padding = '6px 10px';
            emojiBox.style.maxHeight = '180px';
            emojiBox.style.overflowY = 'auto';
            document.body.appendChild(emojiBox);
          }
          const rect = mdEl.getBoundingClientRect();
          emojiBox.style.left = (rect.left + 20) + 'px';
          emojiBox.style.top = (rect.top + 40) + 'px';
          emojiBox.innerHTML = filtered.map(e => `<div style='cursor:pointer;padding:2px 0' data-emoji='${e}'>${e}</div>`).join('');
          emojiBox.querySelectorAll('div').forEach(div => {
            div.onclick = function() {
              const newVal = val.slice(0, pos - query.length - 1) + div.dataset.emoji + val.slice(pos);
              mdEl.value = newVal;
              mdEl.focus();
              emojiBox.remove();
              emojiBox = null;
              renderNow();
            };
          });
        } else if (emojiBox) {
          emojiBox.remove();
          emojiBox = null;
        }
      } else if (emojiBox) {
        emojiBox.remove();
        emojiBox = null;
      }
    });

    let timer = null;
    function setStatus(s){ statusEl.textContent = s; }

    async function renderNow() {
      const markdown = mdEl.value || "";
      setStatus("Rendering...");
      renderBtn.disabled = true;
      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ markdown }),
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data?.html) throw new Error(data?.error || `HTTP ${res.status}`);
        previewEl.innerHTML = data.html;
        previewEl.querySelectorAll("a").forEach(a=>{
          a.setAttribute("rel","noopener noreferrer");
          a.setAttribute("target","_blank");
        });
        setStatus("Ready");
      } catch (err) {
        setStatus("Render Error");
        previewEl.innerHTML = `<div style="background:#2b2030;border:1px solid #5a2b3a;padding:12px;border-radius:10px">
<b>Error:</b> ${(err?.message||err).toString()}<br/>
<span style="color:#aaa">Make sure the server is running and /render endpoint is accessible.</span>
</div>`;
        console.error(err);
      } finally {
        renderBtn.disabled = false;
      }
    }

    function debounceRender() {
      clearTimeout(timer);
      timer = setTimeout(renderNow, 350);
    }

    renderBtn.addEventListener("click", renderNow);
    mdEl.addEventListener("input", () => { if (liveEl.checked) debounceRender(); });

    mdEl.value = `# Welcome to Markdown Renderer âœ¨

This is a Django-based Markdown renderer with live preview support.

## Features
- Convert Markdown to HTML
- Live preview
- Safe HTML tags support
- Clean and functional interface

> To start, edit this text and click "Render" or enable live preview.`;
    renderNow();
  </script>
</body>
</html>